<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <title>three.js - json scene maker</title>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <meta name="robots" content="noindex, nofollow">
        <meta name="googlebot" content="noindex, nofollow">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/91/three.js"></script>
        <script type="text/javascript" src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
        <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

        <script>
            module = {};
        </script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/eligrey/FileSaver.js@cf70d125b048349fb084d8c8395ee790b83c685c/src/FileSaver.js"></script>
        <script src="js/lz-string-1.4.4.js"></script>

        <style type="text/css">
            body {
                overflow: hidden;
                padding: 0;
                margin: 0;
            }
        </style>

        <script type="text/javascript">
            var rfarm = {

            };

            rfarm.createSession = function() {
                console.log("Requesting new session...");
                //todo: implement it

                $.ajax({
                    url: "https://localhost:8000/session",
                    data: { api_key: "75f5-4d53-b0f4" },
                    dataType: "application/json",
                    type: 'POST',
                    success: function(result) {
                        console.log(result);
                    },
                    error: function(err) {
                        console.error(err);
                    }
                });

            };
            rfarm.createScene = function() {
                console.log("Creating new scene...");
                //todo: implement it

                $.ajax({
                    url: "https://localhost:8000/scene",
                    data: { api_key: "75f5-4d53-b0f4" },
                    dataType: "application/json",
                    type: 'POST',
                    success: function(result) {
                        console.log(result);
                    },
                    error: function(err) {
                        console.error(err);
                    }
                });

            }
            rfarm.createCamera = function() {
                console.log("Creating new scene...");
                //todo: implement it

                $.ajax({
                    url: "https://localhost:8000/scene/camera",
                    data: { api_key: "75f5-4d53-b0f4" },
                    dataType: "application/json",
                    type: 'POST',
                    success: function(result) {
                        console.log(result);
                    },
                    error: function(err) {
                        console.error(err);
                    }
                });

            }
            rfarm.createLight = function() {
                console.log("Creating new light...");
                //todo: implement it

                $.ajax({
                    url: "https://localhost:8000/scene/light",
                    data: { api_key: "75f5-4d53-b0f4" },
                    dataType: "application/json",
                    type: 'POST',
                    success: function(result) {
                        console.log(result);
                    },
                    error: function(err) {
                        console.error(err);
                    }
                });

            }
            rfarm.createMesh = function() {
                console.log("Creating new mesh...");
                //todo: implement it

                $.ajax({
                    url: "https://localhost:8000/scene/mesh",
                    data: { api_key: "75f5-4d53-b0f4" },
                    dataType: "application/json",
                    type: 'POST',
                    success: function(result) {
                        console.log(result);
                    },
                    error: function(err) {
                        console.error(err);
                    }
                });

            }

            document.saveSceneAs = function(scene) {
                var sceneJson = scene.toJSON();
                if (sceneJson.images) {
                    delete sceneJson.images;
                }

                var sceneText = JSON.stringify(sceneJson);
                var compressedSceneData = LZString144.compressToBase64(sceneText);

                var blob = new Blob([compressedSceneData], {
                    type: "text/plain;charset=utf-8"
                });
                saveAs(blob, "geometry.bson");
            }

            document.render = function() {
                console.log("Creating new render job...");

                $.ajax({
                    url: "https://localhost:8000/job",
                    data: { api_key: "75f5-4d53-b0f4", session: 123 },
                    dataType: "application/json",
                    type: 'POST',
                    success: function(result) {
                        console.log(result);
                    },
                    error: function(err) {
                        console.error(err);
                    }
                });

            };

            window.onload = function() {
                var renderer;
                var camera;
                var controls;

                rfarm.createSession();

                var scene = new THREE.Scene();
                //todo: user API_KEY to create new session
                //todo: POST /session?api_key=123 => returns session guid
                //todo: create session acquires ownership over one of empty running 3ds max instances, callback => when 3ds max is ready to receive commands
                rfarm.createScene();

                camera = new THREE.PerspectiveCamera(54, window.innerWidth / window.innerHeight, 0.1, 1000);
                //todo: POST PerspectiveCamera on scene, callback => camera guid is set back on camera.userData.resourceId = "123"

                renderer = new THREE.WebGLRenderer({
                    antialias: true
                });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setClearColor(new THREE.Color(0xfefefe));

                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap; // default THREE.PCFShadowMap
                //todo: PUT vray settings

                document.body.appendChild(renderer.domElement);

                camera.position.x = 5;
                camera.position.y = 5;
                camera.position.z = 5;
                camera.lookAt(0, 0, 0);
                //todo: POST camera by resource id
                rfarm.createCamera(camera);

                controls = new THREE.OrbitControls(camera);

                var spotLight = new THREE.SpotLight( 0xffffff );
                spotLight.position.set( 10, 40, 10 );
                spotLight.target.position.set( 0, 0, 0 );
                spotLight.castShadow = true;
				spotLight.shadow.bias = 0.0001;
                spotLight.shadow.mapSize.width  = 1024;
                spotLight.shadow.mapSize.height = 1024;
                spotLight.shadow.camera.near = 10;
                spotLight.shadow.camera.far = 50;
                spotLight.shadow.camera.fov = 30;
                scene.add(spotLight);
                //todo: POST spot light into 3ds max, save light id userData
                rfarm.createLight(spotLight);

                var helper = new THREE.CameraHelper( spotLight.shadow.camera );
                scene.add( helper );

                var gridHelper = new THREE.GridHelper(4, 4);
                scene.add(gridHelper);

                var geometry = new THREE.DodecahedronGeometry(1, 0);
                    geometry = new THREE.BufferGeometry().fromGeometry(geometry);
                var material = new THREE.MeshPhongMaterial({
                    color: 0x40e040,
                    transparent: false,
                    opacity: 0.95
                });
                var cube = new THREE.Mesh(geometry, material);
                cube.applyMatrix(new THREE.Matrix4().makeTranslation(0, 1, 0))
                cube.castShadow = true;
                cube.receiveShadow = false;
                scene.add(cube);
                //todo: POST buffer geometry, save resource id in userData
                // document.saveToJson(cube);
                rfarm.createMesh(cube);

                var geometry = new THREE.PlaneGeometry( 5, 5, 1 );
                var material = new THREE.MeshPhongMaterial( {
                    color: 0xf0ffff, 
                    // side: THREE.DoubleSide
                } );
                var plane = new THREE.Mesh( geometry, material );
                plane.applyMatrix(new THREE.Matrix4().makeRotationX(-Math.PI/2));
                plane.castShadow = false;
                plane.receiveShadow = true;
                scene.add(plane);
                //todo: POST buffer geometry, save resource id in userData
                rfarm.createMesh(plane)

                var animate = function() {
                    requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                };

                animate();

            }
        </script>
    </head>
    <body>
        <button onclick="render()">render</button>
    </body>
</html>