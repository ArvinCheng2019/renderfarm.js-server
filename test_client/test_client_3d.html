<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <title>three.js - json scene maker</title>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <meta name="robots" content="noindex, nofollow">
        <meta name="googlebot" content="noindex, nofollow">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/91/three.js"></script>
        <script type="text/javascript" src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
        <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

        <script>
            module = {};
        </script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/eligrey/FileSaver.js@cf70d125b048349fb084d8c8395ee790b83c685c/src/FileSaver.js"></script>
        <script src="js/lz-string-1.4.4.js"></script>

        <style type="text/css">
            body {
                overflow: hidden;
                padding: 0;
                margin: 0;
            }
        </style>

        <script type="text/javascript">
            var rfarm = {

            };

            rfarm.createSession = function(onCreated) {
                console.log("Requesting new session...");
                //todo: implement it

                $.ajax({
                    url: "https://localhost:8000/session",
                    data: { api_key: "75f5-4d53-b0f4" },
                    type: 'POST',
                    success: function(result) {
                        document.sessionId = result.id;
                        console.log(result);
                        if (onCreated) onCreated(result.id);
                    },
                    error: function(err) {
                        console.error(err.responseJSON);
                    }
                });

            };
            rfarm.createScene = function(onCreated) {
                console.log("Creating new scene...");
                //todo: implement it

                $.ajax({
                    url: "https://localhost:8000/scene",
                    data: { 
                        session: document.sessionId 
                    },
                    type: 'POST',
                    success: function(result) {
                        console.log(result);
                        if (onCreated) onCreated();
                    },
                    error: function(err) {
                        console.error(err);
                    }
                });

            }
            rfarm.createCamera = function(camera, onCameraReady) {
                console.log("Creating new scene...");
                //todo: implement it

                var cameraJson = camera.toJSON();
                cameraJson.object.projectionMatrix = camera.projectionMatrix.elements;

                var cameraWorldDir = new THREE.Vector3();
                camera.getWorldDirection ( cameraWorldDir );
                cameraJson.object.worldDirection = [cameraWorldDir.x, cameraWorldDir.y, cameraWorldDir.z];

                cameraJson.object.position = [camera.position.x, camera.position.y, camera.position.z];
                cameraJson.object.quaternion = [camera.quaternion.x, camera.quaternion.y, camera.quaternion.z, camera.quaternion.w];

                var cameraTarget = camera.position.clone();
                cameraTarget.addScaledVector ( cameraWorldDir, camera.focus );
                cameraJson.object.target = [cameraTarget.x, cameraTarget.y, cameraTarget.z];

                var cameraText = JSON.stringify(cameraJson);
                var compressedCameraData = LZString144.compressToBase64(cameraText);

                $.ajax({
                    url: "https://localhost:8000/scene/camera",
                    data: { 
                        session: document.sessionId,
                        camera: compressedCameraData 
                    },
                    type: 'POST',
                    success: function(result) {
                        console.log(result);
                        onCameraReady(result.id);
                    },
                    error: function(err) {
                        console.error(err);
                    }
                });

            }
            rfarm.createLight = function(onCreated) {
                console.log("Creating new light...");
                //todo: implement it

                $.ajax({
                    url: "https://localhost:8000/scene/skylight",
                    data: { 
                        session: document.sessionId, 
                    },
                    type: 'POST',
                    success: function(result) {
                        console.log(result);
                        if (onCreated) onCreated();
                    },
                    error: function(err) {
                        console.error(err);
                    }
                });

            }
            rfarm.createMesh = function(sceneJson, onMeshReady) {
                console.log("Creating new mesh...");
                //todo: implement it

                var sceneText = JSON.stringify(sceneJson);
                var compressedSceneData = LZString144.compressToBase64(sceneText);

                $.ajax({
                    url: "https://localhost:8000/scene/mesh",
                    data: { 
                        session: document.sessionId, 
                        mesh: compressedSceneData 
                    },
                    type: 'POST',
                    success: function(result) {
                        console.log(result);
                        if (onMeshReady) onMeshReady();
                    },
                    error: function(err) {
                        console.error(err);
                    }
                });

            }

            document.saveSceneAs = function(scene) {
                var sceneJson = scene.toJSON();
                if (sceneJson.images) {
                    delete sceneJson.images;
                }

                var sceneText = JSON.stringify(sceneJson);
                var compressedSceneData = LZString144.compressToBase64(sceneText);

                var blob = new Blob([compressedSceneData], {
                    type: "text/plain;charset=utf-8"
                });
                saveAs(blob, "geometry.bson");
            }

            rfarm.render = function(cameraId, onImageReady) {
                console.log("Creating new render job...");

                var width = $("#viewport").outerWidth();
                var height = $("#viewport").outerHeight();

                $.ajax({
                    url: "https://localhost:8000/job",
                    data: { 
                        session: document.sessionId, 
                        width: width, 
                        height: height, 
                        camera: cameraId 
                    },
                    type: 'POST',
                    success: function(result) {
                        console.log(result);
                        onImageReady(result.url);
                    },
                    error: function(err) {
                        console.error(err);
                    }
                });

            };

            document.renderScene = function() {
                rfarm.createCamera(document.camera, function(cameraId) {
                    document.cameraId = cameraId; //todo: improve here
                    rfarm.render(document.cameraId, function(url) {
                        $('#viewport').css("display", "none");
                        $('#output').attr("src",url);
                    });
                });
            }

            window.onload = function() {
                var renderer;
                var camera;
                var controls;

                var scene = new THREE.Scene();

                camera = new THREE.PerspectiveCamera(54, window.innerWidth / window.innerHeight, 0.1, 1000);
                //todo: POST PerspectiveCamera on scene, callback => camera guid is set back on camera.userData.resourceId = "123"

                renderer = new THREE.WebGLRenderer({
                    antialias: true,
                    canvas: document.getElementById("viewport")
                });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setClearColor(new THREE.Color(0xfefefe));

                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap; // default THREE.PCFShadowMap
                //todo: PUT vray settings

                document.body.appendChild(renderer.domElement);

                camera.position.x = 5;
                camera.position.y = 5;
                camera.position.z = 5;
                camera.lookAt(0, 0, 0);
                camera.updateProjectionMatrix ();
                document.camera = camera;

                controls = new THREE.OrbitControls(camera);

                var spotLight = new THREE.SpotLight( 0xffffff );
                spotLight.position.set( 10, 40, 10 );
                spotLight.target.position.set( 0, 0, 0 );
                spotLight.castShadow = true;
				spotLight.shadow.bias = 0.0001;
                spotLight.shadow.mapSize.width  = 1024;
                spotLight.shadow.mapSize.height = 1024;
                spotLight.shadow.camera.near = 10;
                spotLight.shadow.camera.far = 50;
                spotLight.shadow.camera.fov = 30;
                scene.add(spotLight);

                var helper = new THREE.CameraHelper( spotLight.shadow.camera );
                scene.add( helper );

                var gridHelper = new THREE.GridHelper(4, 4);
                scene.add(gridHelper);

                var geometry = new THREE.DodecahedronGeometry(1, 0);
                    geometry = new THREE.BufferGeometry().fromGeometry(geometry);
                var material = new THREE.MeshPhongMaterial({
                    color: 0x40e040,
                    transparent: false,
                    opacity: 0.95
                });
                var cube = new THREE.Mesh(geometry, material);
                cube.applyMatrix(new THREE.Matrix4().makeTranslation(0, 1, 0))
                cube.castShadow = true;
                cube.receiveShadow = false;
                scene.add(cube);
                //todo: POST buffer geometry, save resource id in userData
                // document.saveToJson(cube);

                var geometry = new THREE.PlaneGeometry( 5, 5, 1 );
                    geometry = new THREE.BufferGeometry().fromGeometry(geometry);
                var material = new THREE.MeshPhongMaterial( {
                    color: 0xf0ffff, 
                    // side: THREE.DoubleSide
                } );

                var plane = new THREE.Mesh( geometry, material );
                plane.applyMatrix(new THREE.Matrix4().makeRotationX(Math.PI/2));
                plane.castShadow = false;
                plane.receiveShadow = true;
                scene.add(plane);

                //todo: now we have to post meshes one by one, this is wrong
                rfarm.createSession(function() {
                    rfarm.createScene(function() {
                        rfarm.createLight(function() {
                        });
                        rfarm.createMesh(cube, function() {
                        });
                        rfarm.createMesh(plane, function() {
                        });
                    });
                });

                var animate = function() {
                    requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                };

                // animate();
            }
        </script>
    </head>
    <body>
        <canvas id="viewport"></canvas>
        <img id="output">
        <button onclick="renderScene()" style="position: fixed; left: 0; top:0;">render</button>
    </body>
</html>