<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <title>three.js - json scene maker</title>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <meta name="robots" content="noindex, nofollow">
        <meta name="googlebot" content="noindex, nofollow">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/91/three.js"></script>
        <script type="text/javascript" src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
        <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

        <script>
            module = {};
        </script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/eligrey/FileSaver.js@cf70d125b048349fb084d8c8395ee790b83c685c/src/FileSaver.js"></script>
        <script src="js/lz-string-1.4.4.js"></script>

        <style type="text/css">
            body {
                overflow: hidden;
                padding: 0;
                margin: 0;
            }
            #progress {
                font-family: monospace;
                margin-left: 24px;
            }
        </style>

        <script src="js/rfarm_client.js"></script>

        <script type="text/javascript">
            document.saveJson = function(jsonObj, filename) {
                var sceneText = JSON.stringify(jsonObj);

                var blob = new Blob([sceneText], {
                    type: "text/plain;charset=utf-8"
                });
                saveAs(blob, filename);
            };

            document.saveSceneAs = function(scene) {
                var sceneJson = scene.toJSON();
                if (sceneJson.images) {
                    delete sceneJson.images;
                }

                var sceneText = JSON.stringify(sceneJson);
                var compressedSceneData = LZString144.compressToBase64(sceneText);

                var blob = new Blob([compressedSceneData], {
                    type: "text/plain;charset=utf-8"
                });
                saveAs(blob, "geometry.bson");
            }

            window.onload = function() {
                var renderer;
                var camera;
                var controls;

                var scene = new THREE.Scene();

                camera = new THREE.PerspectiveCamera(54, 640 / 480, 0.1, 1000);
                //todo: POST PerspectiveCamera on scene, callback => camera guid is set back on camera.userData.resourceId = "123"

                renderer = new THREE.WebGLRenderer({
                    antialias: true,
                    canvas: document.getElementById("viewport")
                });
                // renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setSize(640, 480);
                renderer.setClearColor(new THREE.Color(0xfefefe));

                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap; // default THREE.PCFShadowMap
                //todo: PUT vray settings

                // document.body.appendChild(renderer.domElement);

                camera.position.x = 5;
                camera.position.y = 6;
                camera.position.z = 7;
                camera.lookAt(0, 0, 0);
                camera.updateProjectionMatrix ();

                controls = new THREE.OrbitControls(camera);

                var spotLight = new THREE.SpotLight( 0xffa0c0 );
                spotLight.position.set( 10, 40, 10 );
                spotLight.target.position.set( 0, 0, 0 );
                spotLight.castShadow = true;
				spotLight.shadow.bias = 0.0001;
                spotLight.shadow.mapSize.width  = 1024;
                spotLight.shadow.mapSize.height = 1024;
                spotLight.shadow.camera.near = 10;
                spotLight.shadow.camera.far = 50;
                spotLight.shadow.camera.fov = 30;
                spotLight.target.position.set(0.05,0,0.15);
                scene.add(spotLight);
                document.spotLight = spotLight;

                var helper = new THREE.CameraHelper( spotLight.shadow.camera );
                scene.add( helper );

                var axesHelper = new THREE.AxesHelper( 5 );
                //axesHelper.applyMatrix(new THREE.Matrix4().makeRotationX(-Math.PI/2));
                //axesHelper.applyMatrix(new THREE.Matrix4().makeRotationY(Math.PI/2));
                scene.add( axesHelper );

                var gridHelper = new THREE.GridHelper(4, 4);
                scene.add(gridHelper);

                var geometry = new THREE.DodecahedronGeometry(1, 0);
                    geometry = new THREE.BufferGeometry().fromGeometry(geometry);

                var material = new THREE.MeshPhongMaterial({
                    color: 0x40e040,
                    transparent: false,
                    opacity: 0.95
                });

                var cube = new THREE.Mesh(geometry, material);
                cube.applyMatrix(new THREE.Matrix4().makeTranslation(0, 1, 0))
                cube.castShadow = true;
                cube.receiveShadow = false;
                scene.add(cube);

                var cube2 = new THREE.Mesh(geometry, material);
                cube2.applyMatrix(new THREE.Matrix4().makeTranslation(-1.75, 1, -1.75));
                cube2.castShadow = true;
                cube2.receiveShadow = false;
                scene.add(cube2);

                var material3 = new THREE.MeshPhongMaterial({
                    color: 0x40e0e0,
                    transparent: false,
                    opacity: 0.95
                });

                var cube3 = new THREE.Mesh(geometry, material3);
                cube3.applyMatrix(new THREE.Matrix4().makeTranslation(-1.75, 1, 1.75));
                cube3.castShadow = true;
                cube3.receiveShadow = false;
                scene.add(cube3);
// =============

                var geometry = new THREE.ConeGeometry( 0.5, 3, 32 );
                    geometry = new THREE.BufferGeometry().fromGeometry(geometry);
                var material = new THREE.MeshPhongMaterial({
                    color: 0x40e040,
                    transparent: false,
                    opacity: 0.95
                });
                var cone = new THREE.Mesh( geometry, material );
                cone.applyMatrix(new THREE.Matrix4().makeRotationX(-Math.PI/4));
                cone.applyMatrix(new THREE.Matrix4().makeRotationY(-Math.PI/4));
                cone.applyMatrix(new THREE.Matrix4().makeTranslation(2, 1.2, -2));
                scene.add( cone );

                var planeGeometry = new THREE.PlaneGeometry( 5, 5, 1 );
                    planeGeometry = new THREE.BufferGeometry().fromGeometry(planeGeometry);
                var material = new THREE.MeshPhongMaterial( {
                    color: 0xf0ffff, 
                    // side: THREE.DoubleSide
                } );

                var plane = new THREE.Mesh( planeGeometry, material );
                plane.applyMatrix(new THREE.Matrix4().makeRotationX(-Math.PI/2));
                plane.applyMatrix(new THREE.Matrix4().makeTranslation(0.15,0,0.25));
                plane.castShadow = false;
                plane.receiveShadow = true;
                scene.add(plane);

                var animate = function() {
                    requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                };

                document.renderScene = function() {
                    rfarm.createSession(function(sessionId) {
                        rfarm.openScene(scene, "vray_simple_1.max", function(sceneNodeName) {
                            rfarm.createMesh(cone, function(coneNodeName) {
                                rfarm.createMesh(cube, function(cubeNodeName) {
                                    rfarm.createMesh(cube2, function(cube2NodeName) {
                                        rfarm.createMesh(cube3, function(cube3NodeName) {
                                            rfarm.createSpotlight(spotLight, spotLight.target, function(spotLightName) {
                                                rfarm.createCamera(camera, function(cameraName) {
                                                    var width = $("#viewport").outerWidth();
                                                    var height = $("#viewport").outerHeight();

                                                    rfarm.render(cameraName, width, height, 
                                                        function(jobGuid) {
                                                            document.jobGuid = jobGuid;
                                                        },
                                                        function(progress, elapsed) {
                                                            $("#progress").text("Progress: " + (100 * progress).toFixed(1) + "%, Elapsed: " + (elapsed * 60).toFixed(1) + " sec.");
                                                        }, 
                                                        function(url) {
                                                            $('#viewport').css("display", "none");
                                                            $('#output').attr("src",url);
                                                            $('#progress').css("display", "none");
                                                            // rfarm.closeSession(sessionId);
                                                        });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                };

                document.cancelRender = function() {
                    rfarm.cancelRender( document.jobGuid, function(res) {
                        console.log(res);
                    });
                };

                animate();
            }
        </script>
    </head>
    <body>
        <canvas id="viewport"></canvas>
        <img id="output">
        <button id="render" onclick="renderScene()" style="position: fixed; left: 0; top:0;">render</button>
        <button id="cancel" onclick="cancelRender()" style="position: fixed; left: 70px; top:0;">cancel</button>
        <button id="save" onclick="saveJson(document.spotLight.toJSON(), 'spotLight.json')" style="position: fixed; left: 560px; top:0;">save json</button>
        <div id="progress"></div>
    </body>
</html>